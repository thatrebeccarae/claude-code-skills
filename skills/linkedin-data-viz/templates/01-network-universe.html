<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Universe â€” LinkedIn Data Visualization</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
{{THEME_CSS}}
</style>
</head>
<body>
<div class="container" style="padding:40px;">
<h1 style="font-size:2.2rem;margin-bottom:8px;">Network Universe</h1>
<p class="section-subtitle" id="subtitle"></p>

<div class="stats-row" id="stats"></div>

<div class="card" id="graph-container" style="position:relative;overflow:hidden;">
  <div id="graph" style="width:100%;height:700px;"></div>
  <div class="graph-tooltip" id="tooltip"></div>
  <div class="graph-legend" id="legend"></div>
</div>
</div>

<script>
const DATA = {{DATA}};
const PALETTE = ['#4eadab','#56d4a5','#6bc0be','#8b7ec8','#d4845a','#c9a84c','#8b949e','#4a9f9d','#7d8590','#c75b6f','#5ab8b6','#7dcbc9','#8ed6d4','#9fe1df','#b0ecea','#c1f7f5','#fdfdfe'];

document.getElementById('subtitle').textContent = DATA.subtitle || '';
const statsEl = document.getElementById('stats');
if (DATA.stats) statsEl.innerHTML = DATA.stats.map(s => `<div class="stat"><div class="stat-value">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('');

const gc = document.getElementById('graph');
const w = gc.clientWidth, h = 700;
const svg = d3.select('#graph').append('svg').attr('viewBox', `0 0 ${w} ${h}`).attr('preserveAspectRatio', 'xMidYMid meet');
const tip = document.getElementById('tooltip');

/* Hierarchical: parent nodes + expandable children */
const parentNodes = DATA.nodes.map(n => ({ ...n, _type: 'parent', _expanded: false }));
let allNodes = [...parentNodes];
let allLinks = [...DATA.links];
const childMap = new Map();
DATA.nodes.forEach(p => { if (p.children) childMap.set(p.id, p.children.map(c => ({ ...c, _type: 'child', _parent: p.id, top_companies: [] }))); });

const pScale = d3.scaleSqrt().domain([0, d3.max(parentNodes, d => d.size)]).range([20, 65]);
const cScale = d3.scaleSqrt().domain([0, 120]).range([6, 24]);
function nr(d) { return d._type === 'parent' ? pScale(d.size) : cScale(d.size); }

const linkLayer = svg.append('g');
const nodeLayer = svg.append('g');
let sim;

function restart() {
  const lSel = linkLayer.selectAll('line').data(allLinks, d => (d.source.id||d.source)+'-'+(d.target.id||d.target));
  lSel.exit().transition().duration(300).attr('stroke-opacity',0).remove();
  const lE = lSel.enter().append('line').attr('class','graph-link').attr('stroke-opacity',0);
  const lM = lE.merge(lSel);
  lM.transition().duration(300).attr('stroke-width', d => d._childLink?1:Math.max(1,(d.strength||4)*0.5)).attr('stroke-opacity', d => d._childLink?0.4:0.6).attr('stroke', d => d._childLink?PALETTE[d._group%PALETTE.length]+'44':'rgba(255,255,255,0.1)');

  const nSel = nodeLayer.selectAll('g.node').data(allNodes, d => d.id);
  nSel.exit().transition().duration(300).attr('opacity',0).remove();
  const nE = nSel.enter().append('g').attr('class','node').attr('opacity',0)
    .call(d3.drag().on('start',(e,d)=>{if(!e.active)sim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y}).on('drag',(e,d)=>{d.fx=e.x;d.fy=e.y}).on('end',(e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=null;d.fy=null}));
  nE.append('circle'); nE.append('text').attr('class','node-label').attr('text-anchor','middle'); nE.append('text').attr('class','node-count').attr('text-anchor','middle');
  const nM = nE.merge(nSel);
  nM.transition().duration(300).attr('opacity',1);
  nM.select('circle').attr('r',d=>nr(d)).attr('fill',d=>{const b=PALETTE[d.group%PALETTE.length];return d._type==='child'?b+'aa':b}).attr('fill-opacity',d=>d._type==='child'?0.6:0.8).attr('stroke',d=>PALETTE[d.group%PALETTE.length]).attr('stroke-width',d=>d._type==='child'?1:2).attr('stroke-opacity',0.9).style('cursor',d=>d._type==='parent'&&childMap.has(d.id)?'pointer':'default');
  nM.select('.node-label').attr('dy',d=>d._type==='child'?'0.35em':'-0.3em').style('font-size',d=>d._type==='child'?'9px':'11px').text(d=>d._type==='child'&&nr(d)<14?'':d.id);
  nM.select('.node-count').attr('dy','1em').style('font-size',d=>d._type==='child'?'8px':'10px').text(d=>d._type==='child'&&nr(d)<14?'':d.size);

  nM.on('mouseover',(e,d)=>{
    const info=d._type==='parent'&&d.top_companies?`<div class="companies">Top: ${d.top_companies.join(', ')}</div>`:d._parent?`<div class="companies">Cluster: ${d._parent}</div>`:'';
    const hint=d._type==='parent'&&childMap.has(d.id)?`<div style="margin-top:4px;font-size:0.72rem;color:var(--accent-primary);">Click to ${d._expanded?'collapse':'expand'}</div>`:'';
    tip.innerHTML=`<strong>${d.id}</strong><br>${d.size} connections${info}${hint}`;tip.style.opacity=1;tip.style.left=(e.offsetX+15)+'px';tip.style.top=(e.offsetY-10)+'px';
  }).on('mouseout',()=>{tip.style.opacity=0});

  nM.on('click',(e,d)=>{
    if(d._type!=='parent'||!childMap.has(d.id))return;e.stopPropagation();d._expanded=!d._expanded;
    if(d._expanded){const kids=childMap.get(d.id);kids.forEach(k=>{k.x=d.x+(Math.random()-0.5)*40;k.y=d.y+(Math.random()-0.5)*40});allNodes=allNodes.concat(kids);kids.forEach(k=>{allLinks.push({source:d.id,target:k.id,strength:4,_childLink:true,_group:d.group})})}
    else{const kids=childMap.get(d.id);const kidIds=new Set(kids.map(k=>k.id));allNodes=allNodes.filter(n=>!kidIds.has(n.id));allLinks=allLinks.filter(l=>!l._childLink||((l.source.id||l.source)!==d.id&&!kidIds.has(l.source.id||l.source)))}
    restart();
  });

  if(sim)sim.stop();
  sim=d3.forceSimulation(allNodes).force('link',d3.forceLink(allLinks).id(d=>d.id).distance(d=>d._childLink?40+nr(d.target):160-(d.strength||4)*3)).force('charge',d3.forceManyBody().strength(d=>d._type==='child'?-80:-500)).force('center',d3.forceCenter(w/2,h/2)).force('collision',d3.forceCollide().radius(d=>nr(d)+(d._type==='child'?4:15))).on('tick',()=>{lM.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);nM.attr('transform',d=>`translate(${d.x},${d.y})`)});
  sim.alpha(0.6).restart();
}
restart();

const leg = document.getElementById('legend');
[...parentNodes].sort((a,b)=>b.size-a.size).forEach(n => {
  leg.innerHTML += `<div class="legend-item"><div class="legend-dot" style="background:${PALETTE[n.group%PALETTE.length]}"></div>${n.id} (${n.size})</div>`;
});
</script>
</body>
</html>
