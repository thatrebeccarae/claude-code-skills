<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Universe — LinkedIn Data Visualization</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
{{THEME_CSS}}
</style>
</head>
<body>
<div class="container" style="padding:40px;">
<h1 style="font-size:2.2rem;margin-bottom:8px;">Network Universe</h1>
<p class="section-subtitle" id="subtitle"></p>

<div class="stats-row" id="stats"></div>

<div class="card" id="graph-container" style="position:relative;overflow:hidden;">
  <div id="graph" style="width:100%;height:800px;"></div>
  <div class="graph-tooltip" id="tooltip"></div>
  <div class="graph-legend" id="legend"></div>
</div>
</div>

<script>
const DATA = {{DATA}};
const PALETTE = ['#4eadab','#56d4a5','#6bc0be','#8b7ec8','#d4845a','#c9a84c','#8b949e','#4a9f9d','#7d8590','#c75b6f','#5ab8b6','#7dcbc9','#8ed6d4','#9fe1df','#b0ecea','#c1f7f5','#fdfdfe'];

document.getElementById('subtitle').textContent = DATA.subtitle || '';
const statsEl = document.getElementById('stats');
if (DATA.stats) statsEl.innerHTML = DATA.stats.map(s => `<div class="stat"><div class="stat-value">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('');

const gc = document.getElementById('graph');
const w = gc.clientWidth, h = 800;
const svg = d3.select('#graph').append('svg').attr('viewBox', `0 0 ${w} ${h}`).attr('preserveAspectRatio', 'xMidYMid meet');
const tip = document.getElementById('tooltip');

/* Build parent nodes + recursive child map */
const parentNodes = DATA.nodes.map(n => ({ ...n, _depth: 0, _expanded: true }));
let allNodes = [];
let allLinks = [];
const childMap = new Map();

function buildChildMap(nodes, depth) {
  nodes.forEach(n => {
    if (n.children && n.children.length > 0) {
      const kids = n.children.map(c => ({ ...c, _depth: depth + 1, _parent: n.id, _expanded: false, top_companies: c.top_companies || [] }));
      childMap.set(n.id, kids);
      buildChildMap(n.children, depth + 1);
    }
  });
}
buildChildMap(DATA.nodes, 0);

/* "You" central node */
const youNode = { id: 'You', size: DATA.totalConnections || 1847, group: -1, _depth: -1, _expanded: true };
const maxPS = d3.max(parentNodes, d => d.size);
allNodes.push(youNode);
allNodes = allNodes.concat(parentNodes);

/* You → parent links */
parentNodes.forEach(p => { allLinks.push({ source: 'You', target: p.id, strength: p.size, _youLink: true }); });
allLinks = allLinks.concat(DATA.links);

/* Auto-expand parents on load */
parentNodes.forEach(p => {
  if (childMap.has(p.id)) {
    const kids = childMap.get(p.id);
    allNodes = allNodes.concat(kids);
    kids.forEach(k => { allLinks.push({ source: p.id, target: k.id, strength: k.size, _childLink: true, _group: p.group }); });
  }
});

/* Radius scales */
const youR = 50;
const depthScales = [
  d3.scaleSqrt().domain([0, maxPS]).range([28, 65]),
  d3.scaleSqrt().domain([0, 120]).range([8, 22]),
  d3.scaleSqrt().domain([0, 50]).range([4, 14])
];
function nr(d) { return d._depth === -1 ? youR : depthScales[Math.min(d._depth, 2)](d.size); }

/* Link weight scales */
const maxCS = d3.max(DATA.links, d => d.strength) || 22;
function lw(d) {
  if (d._youLink) return Math.max(1.5, (d.strength / maxPS) * 8);
  if (d._childLink) return Math.max(0.5, (d.strength / 120) * 2);
  return Math.max(1, (d.strength || 4) / maxCS * 4);
}
function lo(d) {
  if (d._youLink) return Math.max(0.2, (d.strength / maxPS) * 0.65);
  if (d._childLink) return Math.max(0.2, (d.strength / 120) * 0.45);
  return Math.max(0.2, (d.strength || 4) / maxCS * 0.5);
}

function getDescendantIds(nodeId) {
  const ids = new Set();
  const kids = childMap.get(nodeId);
  if (!kids) return ids;
  kids.forEach(k => { ids.add(k.id); k._expanded = false; getDescendantIds(k.id).forEach(id => ids.add(id)); });
  return ids;
}

const linkLayer = svg.append('g');
const nodeLayer = svg.append('g');
let sim;
const cx=w/2, cy=h/2;

/* Force-directed, pre-settled before render */
youNode.x=cx;youNode.y=cy;youNode.fx=cx;youNode.fy=cy;
parentNodes.forEach((p,i)=>{const a=(i/parentNodes.length)*2*Math.PI-Math.PI/2;p.x=cx+Math.cos(a)*150;p.y=cy+Math.sin(a)*150;});

function buildSim(){
  if(sim)sim.stop();
  sim=d3.forceSimulation(allNodes)
    .force('link',d3.forceLink(allLinks).id(d=>d.id)
      .distance(d=>{if(d._youLink)return 80+Math.sqrt(d.strength)*8;if(d._childLink)return nr(d.source)+nr(d.target)+15;return 200;})
      .strength(d=>{if(d._youLink)return 0.4;if(d._childLink)return 0.8;return 0.05;}))
    .force('charge',d3.forceManyBody().strength(d=>{if(d._depth===-1)return-1500;if(d._depth===0)return-400-d.size*0.5;return-30;}))
    .force('center',d3.forceCenter(cx,cy).strength(0.05))
    .force('collision',d3.forceCollide().radius(d=>nr(d)+6).strength(0.8));
  youNode.fx=cx;youNode.fy=cy;return sim;
}

function renderDOM(){
  const lSel=linkLayer.selectAll('line').data(allLinks,d=>(d.source.id||d.source)+'-'+(d.target.id||d.target));
  lSel.exit().remove();const lE=lSel.enter().append('line').attr('class','graph-link');const lM=lE.merge(lSel);
  lM.attr('stroke-width',d=>lw(d)).attr('stroke-opacity',d=>lo(d)).attr('stroke',d=>{if(d._youLink)return'rgba(255,255,255,0.4)';if(d._childLink)return PALETTE[d._group%PALETTE.length];return'rgba(255,255,255,0.25)';});
  const nSel=nodeLayer.selectAll('g.node').data(allNodes,d=>d.id);nSel.exit().remove();
  const nE=nSel.enter().append('g').attr('class','node')
    .call(d3.drag().on('start',(e,d)=>{if(d._depth===-1)return;if(!e.active)sim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y}).on('drag',(e,d)=>{if(d._depth===-1)return;d.fx=e.x;d.fy=e.y}).on('end',(e,d)=>{if(d._depth===-1)return;if(!e.active)sim.alphaTarget(0);d.fx=null;d.fy=null}));
  nE.append('circle');nE.append('text').attr('class','node-label').attr('text-anchor','middle');nE.append('text').attr('class','node-count').attr('text-anchor','middle');
  const nM=nE.merge(nSel);nM.attr('opacity',1);
  nM.select('circle').attr('r',d=>nr(d)).attr('fill',d=>d._depth===-1?'#fdfdfe':PALETTE[d.group%PALETTE.length]).attr('fill-opacity',d=>d._depth===-1?0.95:d._depth===0?1.0:d._depth===1?0.85:0.7).attr('stroke',d=>d._depth===-1?'rgba(255,255,255,0.3)':PALETTE[d.group%PALETTE.length]).attr('stroke-width',d=>d._depth<=0?2:1).attr('stroke-opacity',0.9).style('cursor',d=>d._depth>=1?'pointer':'default');
  nM.select('.node-label').attr('dy',d=>d._depth>=1?'0.35em':'-0.3em').style('font-size',d=>d._depth===-1?'13px':d._depth>=2?'7px':d._depth===1?'9px':'11px').style('fill',d=>d._depth===-1?'var(--bg-primary)':'').style('font-weight',d=>d._depth===-1?'600':'').text(d=>nr(d)<12?'':d.id);
  nM.select('.node-count').attr('dy','1em').style('font-size',d=>d._depth>=2?'6px':d._depth===1?'8px':'10px').style('fill',d=>d._depth===-1?'var(--bg-primary)':'').text(d=>d._depth===-1?'':nr(d)<12?'':d.size);
  nM.on('click',(e,d)=>{
    e.stopPropagation();
    if(d._depth>=1){const info=d.top_companies&&d.top_companies.length?`<div class="companies">Top: ${d.top_companies.join(', ')}</div>`:d._parent?`<div class="companies">Cluster: ${d._parent}</div>`:'';tip.innerHTML=`<strong>${d.id}</strong><br>${d.size} connections${info}`;tip.style.opacity=1;tip.style.left=(e.offsetX+15)+'px';tip.style.top=(e.offsetY-10)+'px';}
    if(childMap.has(d.id)&&d._depth>=1){d._expanded=!d._expanded;
      if(d._expanded){const kids=childMap.get(d.id);kids.forEach(k=>{k.x=d.x+(Math.random()-0.5)*30;k.y=d.y+(Math.random()-0.5)*30});allNodes=allNodes.concat(kids);kids.forEach(k=>{allLinks.push({source:d.id,target:k.id,strength:k.size,_childLink:true,_group:d.group})})}
      else{const descIds=getDescendantIds(d.id);allNodes=allNodes.filter(n=>!descIds.has(n.id));allLinks=allLinks.filter(l=>{if(!l._childLink)return true;const sid=l.source.id||l.source;const tid=l.target.id||l.target;return!descIds.has(tid)&&!descIds.has(sid)})}
      render();}
  });
  svg.on('click',()=>{tip.style.opacity=0});
  return{lM,nM};
}

function render(){
  buildSim();sim.tick(300);sim.stop();
  const{lM,nM}=renderDOM();
  lM.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
  nM.attr('transform',d=>`translate(${d.x},${d.y})`);
  sim.on('tick',()=>{lM.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);nM.attr('transform',d=>`translate(${d.x},${d.y})`)});
  sim.alpha(0).restart();
}
render();

const leg = document.getElementById('legend');
leg.innerHTML = `<div class="legend-item"><div class="legend-dot" style="background:#fdfdfe"></div>You</div>`;
[...parentNodes].sort((a,b)=>b.size-a.size).forEach(n => {
  leg.innerHTML += `<div class="legend-item"><div class="legend-dot" style="background:${PALETTE[n.group%PALETTE.length]}"></div>${n.id} (${n.size})</div>`;
});
</script>
</body>
</html>
